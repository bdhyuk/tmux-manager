#!/usr/bin/env bash
# tmux-manager — fzf + tmux split session manager
# Left pane: session list (fzf) | Right pane: live session
# Manager prefix: Ctrl+a  |  Inner tmux prefix: Ctrl+b
# Dependencies: tmux, fzf
set -uo pipefail

VERSION="1.0.0"
REPO_RAW="https://raw.githubusercontent.com/bdhyuk/tmux-manager/main"

SELF="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
MGR_SESSION="_tmux_mgr"

command -v tmux &>/dev/null || { echo "Error: tmux not found. Install: brew install tmux"; exit 1; }
command -v fzf  &>/dev/null || { echo "Error: fzf not found.  Install: brew install fzf"; exit 1; }

# ── Sub-commands (called by fzf / tmux) ────────────────
case "${1:-}" in
    --setup)
        conf="$HOME/.tmux.conf"
        marker="# [tmux-manager]"

        if [[ -f "$conf" ]] && grep -qF "$marker" "$conf"; then
            echo "Already configured in $conf"
            exit 0
        fi

        cat >> "$conf" <<EOF

$marker
set-option -g mouse on
set -g set-clipboard on
set -g status-left-length 40
bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
set -g set-titles on
set -g set-titles-string "#{pane_title}"
set -g allow-rename on
EOF
        echo "Added tmux settings to $conf"
        tmux source "$conf" 2>/dev/null && echo "Settings applied." || echo "Run 'tmux source ~/.tmux.conf' inside tmux to apply."
        exit 0
        ;;
    --list)
        # Collect all session data for grouping by path
        entries=()
        while IFS='§' read -r name windows attached title cwd; do
            status=""
            # Detect Claude Code status via pane_title
            # ✳ = idle indicator, Braille spinner (⠐ etc.) = working
            _blink=$(($(date +%s) % 2))
            if [[ -n "$title" ]]; then
                if [[ "$title" == ✳* ]]; then
                    # Claude Code idle — check for WAIT state
                    # Patterns: permission prompt (Esc to cancel), plan approval (ctrl-g to edit),
                    # question prompt (? [), yes/no prompt ([Y/n] [y/N])
                    bottom=$(tmux capture-pane -p -t "$name" -S -8 2>/dev/null \
                        | sed $'s/\x1b\\[[0-9;]*[a-zA-Z]//g' | tail -6)
                    if echo "$bottom" | grep -qE "Esc to cancel|ctrl-g to edit|\\? \\[|\\[Y/n\\]|\\[y/N\\]"; then
                        if [[ $_blink -eq 0 ]]; then
                            status=$'\033[1;33m[WAIT]\033[0m'
                        else
                            status=$'\033[2;33m[WAIT]\033[0m'
                        fi
                    else
                        status=$'\033[2m[IDLE]\033[0m'
                    fi
                else
                    # Non-✳ title → Claude Code spinner (working)
                    if [[ $_blink -eq 0 ]]; then
                        status=$'\033[1;32m[WORK]\033[0m'
                    else
                        status=$'\033[2;32m[WORK]\033[0m'
                    fi
                fi
            fi

            short_cwd="${cwd/#$HOME/~}"
            entries+=("${short_cwd}§${name}§${windows}§${attached}§${status}§${title}")
        done < <(tmux list-sessions \
            -F '#{session_name}§#{session_windows}w§#{?session_attached,*,}§#{pane_title}§#{pane_current_path}' 2>/dev/null \
            | grep -v "^${MGR_SESSION}§")

        # Sort by path and output hierarchically
        last_path=""
        if [[ ${#entries[@]} -gt 0 ]]; then
            while IFS='§' read -r path name windows attached status title; do
                if [[ "$path" != "$last_path" ]]; then
                    printf '\033[36m%s\033[0m\n' "$path"
                    last_path="$path"
                fi
                if [[ "$attached" == "*" ]]; then
                    dot=$'\033[32m●\033[0m'
                else
                    dot=$'\033[2m○\033[0m'
                fi
                printf "   %-18s %s %b  %b  %s\n" "$name" "$windows" "$dot" "$status" "$title"
            done < <(printf '%s\n' "${entries[@]}" | sort)
        fi
        exit 0
        ;;

    --preview)
        s="$2"
        # Skip folder header lines
        tmux has-session -t "$s" 2>/dev/null || exit 0
        printf '\033[1m%s\033[0m\n\n' "Session: $s"
        while IFS=$'\t' read -r widx wname wpanes; do
            printf '  Window %s: %s (%s panes)\n' "$widx" "$wname" "$wpanes"
            tmux list-panes -t "${s}:${widx}" \
                -F '    Pane #{pane_index}: #{pane_width}x#{pane_height} [#{pane_current_command}]' 2>/dev/null
        done < <(tmux list-windows -t "$s" \
            -F '#{window_index}	#{window_name}	#{window_panes}' 2>/dev/null)
        printf '\n\033[2m── Pane Capture ─────────────────────────\033[0m\n\n'
        tmux capture-pane -p -t "$s" -S -20 2>/dev/null
        exit 0
        ;;

    --connect)
        session="$2"; pane="$3"
        # Skip folder header lines
        tmux has-session -t "$session" 2>/dev/null || exit 0
        tmux respawn-pane -k -t "$pane" \
            "env -u TMUX tmux attach -t '$session'; echo; echo '  Detached. Ctrl+a ← to select another session.'; cat"
        tmux select-pane -t "$pane"
        exit 0
        ;;

    --run-selector)
        right_pane="$2"
        R="$SELF --list"

        list=$("$SELF" --list)
        if [[ -z "$list" ]]; then
            read -rp 'No sessions. Create (name, empty to quit): ' name
            if [[ -n "$name" ]] && ! [[ "$name" =~ [.:\ ] ]]; then
                tmux new-session -d -s "$name"
                list=$("$SELF" --list)
            fi
            if [[ -z "$list" ]]; then
                tmux kill-session -t "$MGR_SESSION" 2>/dev/null
                exit 0
            fi
        fi

        # Auto-refresh: background process sends reload-sync every 2s via fzf --listen
        fzf_port=$((10000 + RANDOM % 50000))
        (
            sleep 1
            while true; do
                sleep 0.1
                curl -s -XPOST "localhost:$fzf_port" -d "reload-sync($R)" 2>/dev/null || break
            done
        ) &
        refresh_pid=$!

        # Background update check (every 10 minutes)
        (
            sleep 5
            while true; do
                remote_ver=$(curl -sf "$REPO_RAW/VERSION" 2>/dev/null | tr -d '[:space:]')
                if [[ -n "$remote_ver" && "$remote_ver" != "$VERSION" ]]; then
                    curl -s -XPOST "localhost:$fzf_port" \
                        -d "change-header(enter:Connect  ^N:New  ^D:Delete  ^R:Rename  ^S:Send  ^U:Update(v$remote_ver)  ^H:Help  esc:Quit
Ctrl+a ←/→: switch panes | Ctrl+b: inner tmux | v$VERSION → v$remote_ver)" 2>/dev/null
                fi
                sleep 600
            done
        ) &
        update_pid=$!

        echo "$list" | fzf \
            --ansi \
            --listen "$fzf_port" \
            --track \
            --reverse --no-multi --cycle \
            --header=$'enter:Connect  ^N:New  ^D:Delete  ^R:Rename  ^S:Send  ^U:Update  ^H:Help  esc:Quit\nCtrl+a ←/→: switch panes | Ctrl+b: inner tmux | v'"$VERSION" \
            --preview "$SELF --preview {1}" \
            --preview-window='down:40%:wrap:follow' \
            --prompt='session> ' \
            --pointer='▶' \
            --color='header:italic' \
            --bind "enter:execute-silent($SELF --connect {1} $right_pane)+reload-sync($R)" \
            --bind "ctrl-n:execute($SELF --action-new)+reload-sync($R)" \
            --bind "ctrl-d:execute($SELF --action-delete {1})+reload-sync($R)" \
            --bind "ctrl-r:execute($SELF --action-rename {1})+reload-sync($R)" \
            --bind "ctrl-s:execute($SELF --action-send {1})+reload-sync($R)" \
            --bind "ctrl-u:execute($SELF --update)+reload-sync($R)" \
            --bind "ctrl-h:execute($SELF --action-help)"

        # fzf exited → clean up
        kill $refresh_pid 2>/dev/null; wait $refresh_pid 2>/dev/null
        kill $update_pid 2>/dev/null; wait $update_pid 2>/dev/null
        tmux kill-session -t "$MGR_SESSION" 2>/dev/null
        exit 0
        ;;

    --action-new)
        read -rp 'New session name: ' name
        [[ -z "$name" ]] && exit 0
        if [[ "$name" =~ [.:\ ] ]]; then
            echo "Error: name cannot contain . : or spaces"; read -rsn1
        elif [[ "$name" == "$MGR_SESSION" ]]; then
            echo "Error: reserved name"; read -rsn1
        elif tmux new-session -d -s "$name" 2>/dev/null; then
            echo "Created: $name"; sleep 0.5
        else
            echo "Error: failed to create (name may already exist)"; read -rsn1
        fi
        exit 0
        ;;

    --action-delete)
        s="$2"
        read -rp "Delete '$s'? [y/N]: " yn
        if [[ "$yn" == [yY] ]]; then
            tmux kill-session -t "$s" 2>/dev/null && echo "Deleted: $s" || echo "Error: failed to delete"
            sleep 0.5
        fi
        exit 0
        ;;

    --action-rename)
        s="$2"
        read -rp "Rename '$s' to: " newname
        [[ -z "$newname" ]] && exit 0
        if [[ "$newname" =~ [.:\ ] ]]; then
            echo "Error: name cannot contain . : or spaces"; read -rsn1
        elif tmux rename-session -t "$s" "$newname" 2>/dev/null; then
            echo "Renamed: $s -> $newname"; sleep 0.5
        else
            echo "Error: failed to rename (name may already exist)"; read -rsn1
        fi
        exit 0
        ;;

    --action-send)
        s="$2"
        read -rp "Command for '$s': " cmd
        [[ -n "$cmd" ]] && tmux send-keys -t "$s" "$cmd" Enter 2>/dev/null \
            && echo "Sent: $cmd" && sleep 0.5
        exit 0
        ;;

    --update)
        echo "Checking for updates... (current: v$VERSION)"
        remote_ver=$(curl -sf "$REPO_RAW/VERSION" 2>/dev/null | tr -d '[:space:]')
        if [[ -z "$remote_ver" ]]; then
            echo "Failed to check. Verify network."; read -rsn1; exit 1
        fi
        if [[ "$remote_ver" == "$VERSION" ]]; then
            echo "Already up to date. (v$VERSION)"; sleep 1; exit 0
        fi
        echo ""
        echo "Update available: v$VERSION → v$remote_ver"
        echo ""
        read -rp "Update? [Y/n]: " yn
        if [[ "$yn" != [nN] ]]; then
            if curl -sf "$REPO_RAW/tmux-manager" -o "$SELF.tmp" && chmod +x "$SELF.tmp"; then
                mv "$SELF.tmp" "$SELF"
                echo "Updated to v$remote_ver! Restart manager to apply."
            else
                rm -f "$SELF.tmp"
                echo "Update failed."
            fi
            read -rsn1
        fi
        exit 0
        ;;

    --action-help)
        cat <<'HELP' | fzf --ansi --reverse --no-multi \
            --header='tmux Cheatsheet (type to search, esc to close)' \
            --prompt='search> ' --pointer='▶'
── Session ──────────────────────────────────────────
Ctrl+b d          Detach from session
Ctrl+b $          Rename current session
Ctrl+b s          List sessions (interactive)
Ctrl+b (          Switch to previous session
Ctrl+b )          Switch to next session

── Window ───────────────────────────────────────────
Ctrl+b c          Create new window
Ctrl+b ,          Rename current window
Ctrl+b &          Kill current window
Ctrl+b w          List windows (interactive)
Ctrl+b n          Next window
Ctrl+b p          Previous window
Ctrl+b 0-9        Switch to window by number
Ctrl+b l          Toggle last active window

── Pane ─────────────────────────────────────────────
Ctrl+b %          Split pane vertically
Ctrl+b "          Split pane horizontally
Ctrl+b x          Kill current pane
Ctrl+b o          Cycle through panes
Ctrl+b ;          Toggle last active pane
Ctrl+b ↑↓←→      Move between panes
Ctrl+b z          Toggle pane zoom (fullscreen)
Ctrl+b {          Move pane left
Ctrl+b }          Move pane right
Ctrl+b Space      Cycle pane layouts
Ctrl+b q          Show pane numbers (press # to jump)

── Resize Pane ──────────────────────────────────────
Ctrl+b Ctrl+↑     Resize pane up
Ctrl+b Ctrl+↓     Resize pane down
Ctrl+b Ctrl+←     Resize pane left
Ctrl+b Ctrl+→     Resize pane right

── Copy Mode (vi) ───────────────────────────────────
Ctrl+b [          Enter copy mode
q                 Exit copy mode
/                 Search forward
?                 Search backward
Space             Start selection
Enter             Copy selection
Ctrl+b ]          Paste buffer

── Misc ─────────────────────────────────────────────
Ctrl+b :          Enter command mode
Ctrl+b t          Show clock
Ctrl+b ?          List all key bindings
HELP
        exit 0
        ;;
esac

# ── Main entry point: set up tmux split layout ────────

# Clean up old manager session
tmux kill-session -t "$MGR_SESSION" 2>/dev/null

# Get terminal size for correct split ratio
if [[ -n "${TMUX:-}" ]]; then
    mgr_cols=$(tmux display-message -p '#{client_width}')
    mgr_lines=$(tmux display-message -p '#{client_height}')
else
    mgr_cols=$(tput cols)
    mgr_lines=$(tput lines)
fi

# Create manager session with correct size
tmux new-session -d -s "$MGR_SESSION" -x "$mgr_cols" -y "$mgr_lines"

# Configure: Ctrl+a prefix so Ctrl+b passes through to inner session
tmux set-option -t "$MGR_SESSION" prefix C-a
tmux set-option -t "$MGR_SESSION" -u prefix2
tmux set-option -t "$MGR_SESSION" mouse on
tmux set-option -t "$MGR_SESSION" status-left ' #[fg=green,bold]MGR#[default] '
tmux set-option -t "$MGR_SESSION" status-right ' ^A: mgr | ^B: session '

# Create right pane (70%) with welcome message
right_cols=$((mgr_cols * 70 / 100))
right_pane=$(tmux split-window -h -t "$MGR_SESSION" -l "$right_cols" -d -P -F '#{pane_id}' \
    "echo; echo '  Select a session from the left pane (Enter).'; echo '  Ctrl+a ←/→ to switch panes.'; echo '  Ctrl+b works normally inside the session.'; echo; cat")

# Get left pane and run selector in it
left_pane=$(tmux list-panes -t "$MGR_SESSION" -F '#{pane_id}' | head -1)
tmux respawn-pane -k -t "$left_pane" "$SELF --run-selector $right_pane"

# Attach/switch to manager
if [[ -n "${TMUX:-}" ]]; then
    tmux switch-client -t "$MGR_SESSION"
else
    exec tmux attach -t "$MGR_SESSION"
fi
